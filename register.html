<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Register</title>
    <style>
        body {
            font-family: sans-serif;
            background-color: #f5f5f5;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
        }

        .register-container {
            background-color: white;
            padding: 2rem;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
            width: 300px;
        }

        h1 {
            text-align: center;
            margin-bottom: 1.5rem;
        }

        label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: bold;
        }

        input[type="email"],
        input[type="password"],
        input[type="text"] { /* Added input type text to styling */
            width: 100%;
            padding: 0.5rem;
            margin-bottom: 1rem;
            border-radius: 4px;
            border: 1px solid #ccc;
        }

        input[type="submit"] {
            width: 100%;
            padding: 0.6rem;
            background-color: #28a745;
            color: white;
            border: none;
            border-radius: 4px;
            font-weight: bold;
            cursor: pointer;
        }

        input[type="submit"]:hover {
            background-color: #218838;
        }

        .error {
            color: red;
            margin-bottom: 1rem;
            display: none;
        }

        .back-link {
            text-align: center;
            margin-top: 1rem;
        }

        .back-link a {
            text-decoration: none;
            color: #007bff;
        }

        .back-link a:hover {
            text-decoration: underline;
        }
    </style>
</head>
<body>
    <div class="register-container">
        <h1>Register</h1>
        <form id="registerForm" onsubmit="return submitForm(event)">
            <div class="error" id="errorMsg"></div>

            <label for="email">Email:</label>
            <input type="email" id="email" name="email" required oninput="populateDisplayName()">

            <label for="password">Password:</label>
            <input type="password" id="password" name="password" required>

            <label for="display_name">Display Name:</label>
            <input type="text" id="display_name" name="display_name" required>

            <input type="submit" value="Register">
        </form>

        <div class="back-link">
            <a href="/login">Back to Login</a>
        </div>
    </div>

    <script>
        // Function to auto-populate display name
        function populateDisplayName() {
            const emailInput = document.getElementById('email');
            const displayNameInput = document.getElementById('display_name');
            const emailValue = emailInput.value;

            // Extract the part before '@'
            const atIndex = emailValue.indexOf('@');
            if (atIndex > 0) {
                let username = emailValue.substring(0, atIndex);
                // Simple capitalization for a nicer display name
                if (username.length > 0) {
                    username = username.charAt(0).toUpperCase() + username.slice(1);
                }
                displayNameInput.value = username;
            } else {
                // Clear or set to empty if no '@' or if the email is invalid/incomplete
                displayNameInput.value = '';
            }
        }

        async function submitForm(event) {
            event.preventDefault();

            const email = document.getElementById('email').value.trim();
            const password = document.getElementById('password').value.trim();
            const displayName = document.getElementById('display_name').value.trim(); // Get display name
            const errorMsg = document.getElementById('errorMsg');

            if (!email || !password || !displayName) { // Validate display name too
                errorMsg.textContent = "Please enter email, password, and display name.";
                errorMsg.style.display = "block";
                return false;
            }

            const formData = new URLSearchParams();
            formData.append("email", email);
            formData.append("password", password);
            formData.append("display_name", displayName); // Append display_name

            const response = await fetch("/register", {
                method: "POST",
                headers: {
                    "Content-Type": "application/x-www-form-urlencoded",
                },
                body: formData.toString(),
            });

            if (response.ok) {
                window.location.href = "/";
            } else {
                let message = "Registration failed.";
                try {
                    const errorData = await response.json();
                    if (errorData.error) {
                        message = errorData.error;
                    }
                } catch (_) {
                    message = await response.text();
                }

                errorMsg.textContent = message;
                errorMsg.style.display = "block";
            }

            return false;
        }
    </script>
</body>
</html>